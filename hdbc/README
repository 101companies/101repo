== Intent ==

[[:Category:Database_management_system|Database]] programming with [[Technology:HDBC]]

== Languages ==

* [[Language:Haskell]]
* [[Language:SQL]] (MySql dialect)

== Technologies ==

* [[Technology:HDBC]]
* [[Technology:MySQL]]
* [[Technology:GHCi]]   
* [[Technology:ODBC]]   

== Features ==

* [[101feature:Company]]
* [[101feature:Total]]
* [[101feature:Cut]]

== Motivation ==

We use [[Technology:HDBC]] for data processing. That is, we use embedded [[Language:SQL]] in [[Language:Haskell]] to [[101feature:Total|total]] 
and [[101feature:Cut|cut]] [[101feature:Company|company]] salaries within a [[:Category:Database_management_system|database]]. In this context we demonstrate the use of [[Prepared statement|prepared statements]] in HDBC. To connect to the [[Technology:MySQL]] database we use an [[Technology:ODBC|ODBC]] backend. The actual functionality to cut and total salaries is independent from the concrete [[:Category:Database_management_system|database implementation]]. 

== Illustration ==

=== Connecting ===

In [this!!Main.hs] we connect to the MySql database by using an ODBC driver and other appropriate connection information:

<syntaxhighlight lang="haskell" source="hdbc/Main.hs">
let connString = "Driver={MySQL ODBC 5.1 Driver};"
              ++ "Server=localhost;"
              ++ "Port=3306;"
              ++ "Database=101companies;"
              ++ "User=root;"
conn <- connectODBC connString
</syntaxhighlight>

=== Cutting ===

The function <syntaxhighlight lang="haskell" enclose="none">cut</syntaxhighlight> defines a statement to cut all salaries:

<syntaxhighlight lang="haskell" source="hdbc/Cut.hs">
cut :: IConnection conn => conn -> String -> IO ()
cut conn cName = do
    stmt <- prepare conn "UPDATE employee SET salary = salary / 2 WHERE employee.cid = (SELECT id FROM Company WHERE name = ?)"
    execute stmt [toSql cName] 
    commit conn
</syntaxhighlight>

We use a prepared statement in which the company name placeholder is then replaced by the given name <syntaxhighlight lang="haskell" enclose="none">cName</syntaxhighlight>. The statement is exectuted and the change is commited to the database.

We can now use the open connection to cut all salaries:
<syntaxhighlight lang="haskell" source="Main.hs">
let cName = "meganalysis"
cut conn cName
</syntaxhighlight>

Functionality to total all salaries uses a SELECT statements instead of UPDATE (see [this!!Total.hs] for details).

== Architecture ==

[this!!Company.sql] and [this!!Meganalysis.sql] provide SQL-scripts to create and populate company tables. [this!!Total.hs] and [this!!Cut.hs] provide totaling and cutting functionality using SQL Statements. [this!!Main.hs] collects test scenarios for totaling and cutting.

== Usage ==

=== Setup ===

We need a local database server.
In the following we explain the steps for XAMPP <cite>xampp</cite>.
We also need some SQL tool.
In the following we explain the steps for the MySQL Workbench <cite>mysqlworkbench</cite>.

* Download and install XAMPP
* Open the "XAMPP Control Panel" and start "Apache" and "Mysql"
* A local MySQL Server is now running:
** '''Server Host''': localhost       
** '''Port''': 3306             
** '''Username''': root             
** '''Password''': (empty password) 
* Connect to database in MySQL Workbench
* Select "101companies" schema or create one
* Create tables (run SQL script Company.sql)
* Populate tables (run SQL script sampleCompany.sql)

=== Testing ===

* [this!!Main.hs] has to be loaded into GHCi. 
* The <syntaxhighlight lang="haskell" enclose="none">main</syntaxhighlight> function has to be applied.
* The output should be equal to the content of the file [this!!baseline].
One can also use the [this!!Makefile] with a target ''test'' for [[test automation]].

== Contributors ==

* {{101contributor|Thomas Schmorleiz|developer}}

== References ==

<biblio>
#xampp bibtex=@online{xampp,
  title = "{Apache friends: XAMPP}",
  note = {\newline \url{http://www.apachefriends.org/en/xampp.html}}
}

#mysqlworkbench bibtex=@online{mysqlworkbench,
  title = "{MySQL Workbench}",
  note = {\newline \url{http://dev.mysql.com/downloads/workbench/}}
}