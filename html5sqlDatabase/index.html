<!DOCTYPE HTML>
<!-- This is the code for the 101companies application written in HTML 5, JavaScript and sql to create a local database -->

<!-- CLIENT-SIDE, SESSION-STORAGE -->
<html>
<head>

<script type="text/javascript">
// -------------------------------------------------------------------------------------------------------------- create DATABASE

var main = {};
main.db = openDatabase('101companies', '1.0', 'companies database', 2 * 1024 * 1024);

// -------------------------------------------------------------------------------------------------------------- create TABLES for 101companies
function createTables() {
	// create tables for:
	main.db.transaction(function (tx) {
		tx.executeSql('DROP TABLE IF EXISTS Company');
		tx.executeSql('DROP TABLE IF EXISTS Department');
		tx.executeSql('DROP TABLE IF EXISTS Employee');
	
		// company
		tx.executeSql('CREATE TABLE IF NOT EXISTS Company (id UNIQUE, name)');
		
		// department
		tx.executeSql('CREATE TABLE IF NOT EXISTS Department (id UNIQUE, name, cid, did)');
		
		// employee
		tx.executeSql('CREATE TABLE IF NOT EXISTS Employee (id UNIQUE, name, address, salary, manager, cid, did)');
	});
}

// -------------------------------------------------------------------------------------------------------------- create DATA for 101companies
function createCompanies() {
	// create data for companies
	main.db.transaction(function (tx) {
		tx.executeSql('INSERT INTO Company (id, name) VALUES (0, "Meganalysis")');
	});
}

function createDepartments() {
	// create data for departments
	main.db.transaction(function (tx) {
		tx.executeSql('INSERT INTO Department (id, name, cid) VALUES (0, "Research", 0)');
		tx.executeSql('INSERT INTO Department (id, name, cid) VALUES (1, "Development", 0)');
		tx.executeSql('INSERT INTO Department (id, name, did) VALUES (2, "Dev1", 1)');
		tx.executeSql('INSERT INTO Department (id, name, did) VALUES (3, "Dev1.1", 2)');
	});
}

function createEmployees() {
	// create data for employees
	main.db.transaction(function (tx) {
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (0, "Craig", "Redmond", 123456.0, 1, 1, 0)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (1, "Ray", "Redmond", 234567.0, 1, 1, 1)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (2, "Klaus", "Boston", 23456.0, 1, 1, 2)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (3, "Karl", "Riga", 2345.0, 1, 1, 3)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (4, "Erik", "Utrecht", 12345.0, 0, 1, 0)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (5, "Ralf", "Koblenz", 1234.0, 0, 1, 0)');
		tx.executeSql('INSERT INTO Employee (id, name, address, salary, manager, cid, did) VALUES (6, "Joe", "Wifi City", 2344.0, 0, 1, 3)');
	});
}

function createData() {
	// create data for the company
	createCompanies();
	createDepartments();
	createEmployees();
}

// -------------------------------------------------------------------------------------------------------------- Create SELECTIONS

function setName(id, name) {
	main.db.transaction(function (tx) {
		tx.executeSql('UPDATE Employee SET name = "' + name + '" WHERE id = ' + id, [], function (tx, results) {
		}, null);
	});
}

function setAddress(id, address) {
	main.db.transaction(function (tx) {
		tx.executeSql('UPDATE Employee SET address = "' + address + '" WHERE id = ' + id, [], function (tx, results) {
		}, null);
	});
}

function setSalary(id, salary) {
	main.db.transaction(function (tx) {
		tx.executeSql('UPDATE Employee SET salary = ' + salary + ' WHERE id = ' + id, [], function (tx, results) {
		}, null);
	});
}

function selectEmployee(id) {
	main.db.transaction(function (tx) {
		tx.executeSql('SELECT * FROM Employee WHERE id = ' + id, [], function (tx, results) {
			var name = results.rows.item(0).name;
			var address = results.rows.item(0).address;
			var salary = results.rows.item(0).salary;
			var manager = results.rows.item(0).manager;
			var departmentId = results.rows.item(0).did;
		
			var employee = "Name:<br><input name=\"name\" type=\"text\" size=\"30\" maxlength=\"30\" value=\"" + name + "\" onchange=\"setName(" + id + ", this.value)\"><br>";
			employee += "Address:<br><input name=\"address\" type=\"text\" size=\"30\" maxlength=\"30\" value=\"" + address + "\" onchange=\"setAddress(" + id + ", this.value)\"><br>";
			employee += "Salary:<br><input name=\"salary\" type=\"text\" size=\"30\" maxlength=\"30\" value=\"" + salary + "\" onchange=\"setSalary(" + id + ", this.value)\"><br>";
			
			document.querySelector('#subheadline').innerHTML = "<h3> Employee: " + name + "</h3>";
			document.querySelector('#departments').innerHTML = "";
			document.querySelector('#employees').innerHTML = employee;
			document.querySelector('#total').innerHTML = "";
			document.querySelector('#back').innerHTML = "<br><input type=\"button\" name=\"back\" value=\"back\" onclick=\"selectDepartment(" + departmentId + ")\">";
			
		}, null);
	});
}

function selectDepartment(id) {
	main.db.transaction(function (tx) {
		tx.executeSql('SELECT * FROM Department WHERE id = ' + id, [], function (tx, results) {
			var name = results.rows.item(0).name;
			var parent = results.rows.item(0).did;
			
			document.querySelector('#subheadline').innerHTML = "<h3> Department: " + name + "</h3>";
			if (parent) {
				document.querySelector('#back').innerHTML = "<br><input type=\"button\" name=\"back\" value=\"back\" onclick=\"selectDepartment(" + parent + ")\">";
			} else {
				document.querySelector('#back').innerHTML = "<br><input type=\"button\" name=\"back\" value=\"back\" onclick=\"selectDepartmentsForCompany(0, 'Meganalysis')\">";
			}
		}, null);
		
		tx.executeSql('SELECT * FROM Department WHERE did = ' + id, [], function (tx, results) {

		
			var len = results.rows.length, i;
			var departments = "Departments: <br>";
			departments += "<form action=\"select1.htm\">";
			departments += "<p>";
			departments += "<select name=\"Departments\" size=\"5\" STYLE=\"width:100px;\">";
			
			for (var i = 0; i < len; i++) {
				if(i == 0) {
					departments += "<option value=\"" + results.rows.item(i).id + "\" selected>";
				} else {
					departments += "<option value=\"" + results.rows.item(i).id + "\">";
				}
				departments += results.rows.item(i).name + "</option>";
			}
			departments += "</select>";
			departments += "</p>";
			
			departments += "<input type=\"button\" value=\"select\" onclick=\"selectDepartment(this.form.Departments.options[this.form.Departments.selectedIndex].value)\" >";
			departments += "</form>";
			
			document.querySelector('#departments').innerHTML = departments;
			
		}, null);
		
		tx.executeSql('SELECT * FROM Employee WHERE did = ' + id, [], function (tx, results) {
			var len = results.rows.length, i;
			var employees = "Employees: <br>";
			var manager = "Manager: <br>";
			var employeeTemp = "";
			
			employees += "<form action=\"select1.htm\">";
			employees += "<p>";
			employees += "<select name=\"Employees\" size=\"5\" STYLE=\"width:100px;\">";
			
			var elementSelected = false;
			for (var i = 0; i < len; i++) {
				if (results.rows.item(i).manager == 0) {
					if(elementSelected == false) {
						employees += "<option value=\"" + results.rows.item(i).id + "\" selected>";
						elementSelected = true;
					} else {
						employees += "<option value=\"" + results.rows.item(i).id + "\">";
					}
					employees += results.rows.item(i).name + "</option>";
				} else {
					manager += "<input type=\"button\" name=\""
						+ results.rows.item(i).name
						+ "\" value=\"" 
						+ results.rows.item(i).name
						+ "\" onclick=\"selectEmployee('" 
						+ results.rows.item(i).id
						+ "')\"><br>";
				}
			}
			employees += "</select>";
			employees += "</p>";
			
			employees += "<input type=\"button\" value=\"select\" onclick=\"selectEmployee(this.form.Employees.options[this.form.Employees.selectedIndex].value)\" >";
			employees += "</form>";

			document.querySelector('#employees').innerHTML = manager + employees;
		}, null);
		
	});
	
	totalForDepartment(id);
}

function selectDepartmentsForCompany(id, name) {
	main.db.transaction(function (tx) {
		tx.executeSql('SELECT * FROM Department WHERE cid = ' + id, [], function (tx, results) {
			document.querySelector('#headline').innerHTML = "<h2> Company: " + name + "</h2>";
			document.querySelector('#subheadline').innerHTML = "";
			
			var len = results.rows.length, i;
			var departments = "Departments: <br>";
			departments += "<form action=\"select1.htm\">";
			departments += "<p>";
			departments += "<select name=\"Departments\" size=\"5\" STYLE=\"width:100px;\">";
			
			for (var i = 0; i < len; i++) {
				if(i == 0) {
					departments += "<option value=\"" + results.rows.item(i).id + "\" selected>";
				} else {
					departments += "<option value=\"" + results.rows.item(i).id + "\">";
				}
				departments += results.rows.item(i).name + "</option>";
			}
			departments += "</select>";
			departments += "</p>";
			
			departments += "<input type=\"button\" value=\"select\" onclick=\"selectDepartment(this.form.Departments.options[this.form.Departments.selectedIndex].value)\" >";
			departments += "</form>";
			
			document.querySelector('#departments').innerHTML = departments;
			document.querySelector('#employees').innerHTML = "";
			document.querySelector('#back').innerHTML = "";
			
		}, null);
	});
	
	totalAll();
}

function totalForDepartment(id) {
	main.totalDepartment = 0;
	main.db.transaction(function (tx) {
		tx.executeSql('SELECT * FROM Employee WHERE did = ' + id, [], function (tx, results) {
			var len = results.rows.length, i;
			
			for (var i = 0; i < len; i++) {
				main.totalDepartment += results.rows.item(i).salary;
			}
			
		}, null);
	});
	//delay(1000);
	document.querySelector('#total').innerHTML = "<br>Total: " + main.totalDepartment + "<input type=\"button\" name=\"cut\" value=\"cut\" onclick=\"cutDepartment(" + id + ")\">";
}

function delay(gap){
	var then,now;
	then=new Date().getTime();
	now=then;
	while((now-then)<gap) {
		now=new Date().getTime();
	}
}

function cutDepartment(id) {
	document.querySelector('#total').innerHTML = "<br>Total: " + main.totalDepartment + "<input type=\"button\" name=\"cut\" value=\"cut\" onclick=\"cutDepartment(" + id + ")\">";
	/*main.db.transaction(function (tx) {
		tx.executeSql('UPDATE Employee SET salary = salary / 2 WHERE did = ' + id, [], function (tx, results) {
					
		}, null);
	});*/
	
	//totalForDepartment(id);
}

function totalAll() {
	main.db.transaction(function (tx) {
		tx.executeSql('SELECT * FROM Employee', [], function (tx, results) {
			var len = results.rows.length, i;
			var total = 0;
			for (var i = 0; i < len; i++) {
				total += results.rows.item(i).salary;
			}
			
			document.querySelector('#total').innerHTML = "<br>Total: " + total + "<input type=\"button\" name=\"cut\" value=\"cut\" onclick=\"cutAll()\">";
			
		}, null);
	});
}

function cutAll() {
	main.db.transaction(function (tx) {
		tx.executeSql('UPDATE Employee SET salary = salary / 2', [], function (tx, results) {
					
		}, null);
	});
	
	totalAll();
}

</script> 

</head>
<body>

<center>

<h1>101companies HTML 5 WebApp with offline sql database</h1>

<script>
// -------------------------------------------------------------------------------------------------------------- INIT
createTables();
createData();
selectDepartmentsForCompany(0, "Meganalysis");
</script>

<!-- Page Structure -->
<div id="headline" name="headline"></div><br>
<hr/>
<div id="subheadline" name="subheadline"></div><br>
<div id="employees" name="employees"></div><br>
<div id="departments" name="departments"></div><br>
<hr/>
<div id="total" name="total"></div><br>
<hr/>
<div id="back" name="back"></div>

</center>

</body>
</html> 